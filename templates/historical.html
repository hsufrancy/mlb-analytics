<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Analytics - Historical Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>‚öæ MLB Analytics System</h1>
                <p class="subtitle">Lambda Architecture - Real-time & Batch Analytics</p>
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Live Dashboard</a>
                <a href="/historical" class="nav-link active">Historical Analytics</a>
            </nav>
        </header>

        <!-- Query 1: Team Performance -->
        <section class="section">
            <h2 class="section-title">üìä Query 1: Team Performance</h2>
            <div class="query-form">
                <select id="team1-select" class="select-input">
                    <option value="">Select Team...</option>
                </select>
                <select id="season1-select" class="select-input">
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                    <option value="2018" selected>2018</option>
                    <option value="2020">2020</option>
                </select>
                <button onclick="queryTeamPerformance()" class="btn">Search</button>
            </div>
            <div id="team-performance-result" class="result-container"></div>
        </section>

        <!-- Query 2: Head-to-Head Matchup -->
        <section class="section">
            <h2 class="section-title">‚öîÔ∏è Query 2: Head-to-Head Matchup</h2>
            <div class="query-form">
                <select id="matchup-team1" class="select-input">
                    <option value="">Team 1...</option>
                </select>
                <select id="matchup-team2" class="select-input">
                    <option value="">Team 2...</option>
                </select>
                <select id="matchup-season" class="select-input">
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                    <option value="2018" selected>2018</option>
                    <option value="2020">2020</option>
                </select>
                <button onclick="queryMatchup()" class="btn">Search</button>
            </div>
            <div id="matchup-result" class="result-container"></div>
        </section>

        <!-- Query 3: League Trends -->
        <section class="section">
            <h2 class="section-title">üìà Query 3: League-Wide Trends</h2>
            <button onclick="queryLeagueTrends()" class="btn">Load Trends</button>
            <div id="trends-result" class="result-container"></div>
        </section>
    </div>

    <script>
        // ====== Global DOM refs for Query 1 & 2 ======
        const team1Select = document.getElementById('team1-select');      // Query 1
        const matchupTeam1Select = document.getElementById('matchup-team1'); // Query 2
        const matchupTeam2Select = document.getElementById('matchup-team2'); // Query 2

        let allTeams = [];

        // ---------- Load teams on page load ----------
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                allTeams = await response.json();

                populateTeamSelect(team1Select, allTeams, 'Select Team...');

                populateTeamSelect(matchupTeam1Select, allTeams, 'Team 1...');
                populateTeamSelect(matchupTeam2Select, allTeams, 'Team 2...');

                enforceDifferentTeams();
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        function populateTeamSelect(selectEl, teams, placeholderText) {
            if (!selectEl) return;
            selectEl.innerHTML =
                `<option value="">${placeholderText}</option>` +
                teams.map(team => `<option value="${team}">${team}</option>`).join('');
        }

        function enforceDifferentTeams() {
            if (!matchupTeam1Select || !matchupTeam2Select) return;

            const t1 = matchupTeam1Select.value;
            const t2 = matchupTeam2Select.value;

            Array.from(matchupTeam2Select.options).forEach(opt => {
                if (!opt.value) {
                    opt.disabled = false;
                } else {
                    opt.disabled = (opt.value === t1);
                }
            });

            Array.from(matchupTeam1Select.options).forEach(opt => {
                if (!opt.value) {
                    opt.disabled = false;
                } else {
                    opt.disabled = (opt.value === t2);
                }
            });

            if (t1 && t1 === t2) {
                matchupTeam2Select.value = '';
            }
        }

        if (matchupTeam1Select) {
            matchupTeam1Select.addEventListener('change', enforceDifferentTeams);
        }
        if (matchupTeam2Select) {
            matchupTeam2Select.addEventListener('change', enforceDifferentTeams);
        }

        // ---------- Query 1: Team Performance ----------
        async function queryTeamPerformance() {
            const team = document.getElementById('team1-select').value;
            const season = document.getElementById('season1-select').value;
            
            if (!team) {
                alert('Please select a team');
                return;
            }

            try {
                const response = await fetch(`/api/team-performance?team=${team}&season=${season}`);
                const data = await response.json();
                
                document.getElementById('team-performance-result').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Season</div>
                            <div class="stat-value">${data.season}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Record</div>
                            <div class="stat-value">${data.wins}-${data.losses}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Win %</div>
                            <div class="stat-value">${(data.win_pct * 100).toFixed(1)}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Home</div>
                            <div class="stat-value">${data.home_record}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Away</div>
                            <div class="stat-value">${data.away_record}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Runs Scored</div>
                            <div class="stat-value">${data.runs_scored}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Runs Allowed</div>
                            <div class="stat-value">${data.runs_allowed}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Run Diff</div>
                            <div class="stat-value">${data.run_differential > 0 ? '+' : ''}${data.run_differential}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('team-performance-result').innerHTML = 
                    '<p class="error">Error loading data</p>';
            }
        }

        // ---------- Query 2: Matchup ----------
        async function queryMatchup() {
            const team1 = document.getElementById('matchup-team1').value;
            const team2 = document.getElementById('matchup-team2').value;
            const season = document.getElementById('matchup-season').value;
            
            if (!team1 || !team2) {
                alert('Please select both teams');
                return;
            }

            if (team1 === team2) {
                alert('Please select two different teams');
                return;
            }

            try {
                const response = await fetch(`/api/matchup-history?team1=${team1}&team2=${team2}&season=${season}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('matchup-result').innerHTML = 
                        `<p class="error">${data.error}</p>`;
                    return;
                }
                
                document.getElementById('matchup-result').innerHTML = `
                    <div class="matchup-display">
                        <h3>${data.team1} vs ${data.team2} (${data.season})</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Games</div>
                                <div class="stat-value">${data.total_games}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">${data.team1} Wins</div>
                                <div class="stat-value">${data.team1_wins}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">${data.team2} Wins</div>
                                <div class="stat-value">${data.team2_wins}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg Runs/Game</div>
                                <div class="stat-value">${Number(data.avg_runs).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('matchup-result').innerHTML = 
                    '<p class="error">Error loading matchup data</p>';
            }
        }

        // ---------- Query 3: League Trends ----------
        async function queryLeagueTrends() {
            try {
                const response = await fetch('/api/league-trends');
                const trends = await response.json();
                
                document.getElementById('trends-result').innerHTML = `
                    <table class="trends-table">
                        <thead>
                            <tr>
                                <th>Season</th>
                                <th>Games</th>
                                <th>Avg Runs/Game</th>
                                <th>Home Win %</th>
                                <th>Close Games %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trends.map(t => `
                                <tr>
                                    <td>${t.season}</td>
                                    <td>${t.total_games}</td>
                                    <td>${t.avg_runs.toFixed(2)}</td>
                                    <td>${(t.home_win_pct * 100).toFixed(1)}%</td>
                                    <td>${(t.close_game_pct * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('trends-result').innerHTML = 
                    '<p class="error">Error loading trends</p>';
            }
        }

        // Load teams when page loads
        loadTeams();
    </script>
</body>
</html>